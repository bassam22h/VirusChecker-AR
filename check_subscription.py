import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ContextTypes,
    CallbackQueryHandler,
    MessageHandler,
    filters
)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ù‚Ø±Ø§Ø¡Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
CHANNEL_USERNAME = os.environ.get("CHANNEL_USERNAME", "").strip("@")
CHANNEL_LINK = os.environ.get("CHANNEL_LINK", "")
BOT_USERNAME = os.environ.get("BOT_USERNAME", "").strip("@")

async def check_subscription(user_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©"""
    try:
        if not CHANNEL_USERNAME:
            logger.warning("Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† CHANNEL_USERNAME ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©")
            return True
            
        member = await context.bot.get_chat_member(
            chat_id=f"@{CHANNEL_USERNAME}",
            user_id=user_id
        )
        return member.status in ["member", "administrator", "creator"]
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {str(e)}")
        return False

async def send_subscription_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"""
    keyboard = [
        [InlineKeyboardButton("Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©", url=CHANNEL_LINK or f"https://t.me/{CHANNEL_USERNAME}")],
        [InlineKeyboardButton("ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ âœ…", callback_data="check_subscription")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message_text = (
        "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§ØªÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹\n\n"
        "Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØªØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø´ØªØ±ÙƒØ§Ù‹ ÙÙŠ Ù‚Ù†Ø§ØªÙ†Ø§:\n"
        f"@{CHANNEL_USERNAME}\n\n"
        "Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ' Ù„Ù„ØªØ­Ù‚Ù‚"
    )
    
    if update.callback_query:
        await update.callback_query.edit_message_text(
            text=message_text,
            reply_markup=reply_markup
        )
    else:
        await update.message.reply_text(
            text=message_text,
            reply_markup=reply_markup
        )

async def subscription_check_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¶ØºØ· Ø²Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"""
    query = update.callback_query
    await query.answer()
    
    if await check_subscription(query.from_user.id, context):
        await query.edit_message_text("Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø´ØªØ±Ø§ÙƒÙƒ! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª ğŸ‰")
        return True
    else:
        await send_subscription_message(update, context)
        return False

async def check_subscription_middleware(update: Update, context: ContextTypes.DEFAULT_TYPE, next_handler):
    """ÙˆØ³ÙŠØ· Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø£Ù…Ø±"""
    # Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙŠ Ù„Ø§ ØªØªØ·Ù„Ø¨ Ø§Ø´ØªØ±Ø§ÙƒØ§Ù‹
    if update.effective_message and update.effective_message.text in ['/start', '/help']:
        return await next_handler(update, context)
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    if not await check_subscription(update.effective_user.id, context):
        await send_subscription_message(update, context)
        return
    
    return await next_handler(update, context)

def setup_subscription_handlers(application):
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"""
    application.add_handler(CallbackQueryHandler(
        subscription_check_handler,
        pattern="^check_subscription$"
    ))
